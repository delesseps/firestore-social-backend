!function(e,t){for(var r in t)e[r]=t[r]}(this,function(e){var t={};function r(o){if(t[o])return t[o].exports;var n=t[o]={i:o,l:!1,exports:{}};return e[o].call(n.exports,n,n.exports,r),n.l=!0,n.exports}return r.m=e,r.c=t,r.d=function(e,t,o){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(r.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(o,n,function(t){return e[t]}.bind(null,n));return o},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=14)}([function(e,t){e.exports=require("firebase-functions")},function(e,t,r){"use strict";var o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const n=o(r(16));t.adminDB=n.initializeApp(),t.firestoreDB=t.adminDB.firestore()},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=r(18);t.SocialError=o.SocialError;const n=r(19);t.BaseDomain=n.BaseDomain;const s=r(20);t.Feed=s.Feed},function(e,t){e.exports=require("express")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e.Accepted=202]="Accepted",e[e.Ambiguous=300]="Ambiguous",e[e.BadGateway=502]="BadGateway",e[e.BadRequest=400]="BadRequest",e[e.Conflict=409]="Conflict",e[e.Continue=100]="Continue",e[e.Created=201]="Created",e[e.ExpectationFailed=417]="ExpectationFailed",e[e.Forbidden=403]="Forbidden",e[e.Found=302]="Found",e[e.GatewayTimeout=504]="GatewayTimeout",e[e.Gone=410]="Gone",e[e.HttpVersionNotSupported=505]="HttpVersionNotSupported",e[e.InternalServerError=500]="InternalServerError",e[e.LengthRequired=411]="LengthRequired",e[e.MethodNotAllowed=405]="MethodNotAllowed",e[e.Moved=301]="Moved",e[e.MovedPermanently=301]="MovedPermanently",e[e.MultipleChoices=300]="MultipleChoices",e[e.NoContent=204]="NoContent",e[e.NonAuthoritativeInformation=203]="NonAuthoritativeInformation",e[e.NotAcceptable=406]="NotAcceptable",e[e.NotFound=404]="NotFound",e[e.NotImplemented=501]="NotImplemented",e[e.NotModified=304]="NotModified",e[e.OK=200]="OK",e[e.PartialContent=206]="PartialContent",e[e.PaymentRequired=402]="PaymentRequired",e[e.PreconditionFailed=412]="PreconditionFailed",e[e.ProxyAuthenticationRequired=407]="ProxyAuthenticationRequired",e[e.Redirect=302]="Redirect",e[e.RedirectKeepVerb=307]="RedirectKeepVerb",e[e.RedirectMethod=303]="RedirectMethod",e[e.RequestedRangeNotSatisfiable=416]="RequestedRangeNotSatisfiable",e[e.RequestEntityTooLarge=413]="RequestEntityTooLarge",e[e.RequestTimeout=408]="RequestTimeout",e[e.RequestUriTooLong=414]="RequestUriTooLong",e[e.ResetContent=205]="ResetContent",e[e.SeeOther=303]="SeeOther",e[e.ServiceUnavailable=503]="ServiceUnavailable",e[e.SwitchingProtocols=101]="SwitchingProtocols",e[e.TemporaryRedirect=307]="TemporaryRedirect",e[e.Unauthorized=401]="Unauthorized",e[e.UnsupportedMediaType=415]="UnsupportedMediaType",e[e.Unused=306]="Unused",e[e.UpgradeRequired=426]="UpgradeRequired",e[e.UseProxy=305]="UseProxy"}(t.HttpStatusCode||(t.HttpStatusCode={}))},function(e,t){e.exports=require("moment")},function(e,t){e.exports=require("body-parser")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.Verification=class{constructor(e,t,r,o,n,s,i=!1){this.id=e,this.code=t,this.target=r,this.creationDate=o,this.remoteIpAddress=n,this.userId=s,this.isVerified=i}}},function(e,t){e.exports=require("request")},function(e,t){e.exports=require("cookie-parser")},function(e,t){e.exports=require("bcrypt")},function(e,t){e.exports=require("cors")},function(e,t,r){"use strict";var o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const n=o(r(0)),s=r(23),i=n.config().gmail.email,a=n.config().gmail.password,c=s.createTransport({service:"gmail",auth:{user:i,pass:a}});t.emailAPI={sendEmail:e=>new Promise((t,r)=>{const o={from:e.from,to:e.to,subject:e.subject,html:e.html};c.sendMail(o).then(()=>{console.log(`New subscription confirmation email sent to: ${e.to}`),t()}).catch(e=>{console.error("There was an error while sending the email:",e),r(e)})})}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.Email=class{constructor(e,t,r,o,n){this.from=e,this.to=t,this.subject=r,this.html=o,this.text=n}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=r(15);t.onUserCreate=o.onUserCreate,t.auth=o.auth;var n=r(22);t.publicAuth=n.publicAuth;var s=r(24);t.users=s.users,t.onUpdateUserInfo=s.onUpdateUserInfo;var i=r(25);t.onCreateFeedback=i.onCreateFeedback;var a=r(26);t.onAddComment=a.onAddComment,t.onDeleteComment=a.onDeleteComment},function(e,t,r){"use strict";var o=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(n,s){function i(e){try{c(o.next(e))}catch(e){s(e)}}function a(e){try{c(o.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,a)}c((o=o.apply(e,t||[])).next())}))},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=n(r(0)),a=r(1),c=r(17),d=s(r(5)),u=s(r(3)),l=n(r(6)),f=r(2),p=r(7),h=r(4),m=r(21),v=r(8),S=r(9)(),g=r(10),y=i.config().setting.appname;t.onUserCreate=i.auth.user().onCreate(e=>new Promise((t,r)=>{const o=e,n=new c.Circle;return n.creationDate=d.default().unix(),n.name="Following",n.ownerId=o.uid,n.isSystem=!0,a.firestoreDB.collection("users").doc(o.uid).collection("circles").add(Object.assign({},n)).then(()=>{t()}).catch(r)}));const b=u.default(),w=r(11)({origin:!0});b.disable("x-powered-by"),b.use(w),b.use(l.json()),b.use(S),b.use((e,t,r)=>{if(console.log("Check if request is authorized with Firebase ID token"),!(e.headers.authorization&&e.headers.authorization.startsWith("Bearer ")||e.cookies.__session))return console.error("No Firebase ID token was passed as a Bearer token in the Authorization header.","Make sure you authorize your request by providing the following HTTP header:","Authorization: Bearer <Firebase ID Token>",'or by passing a "__session" cookie.'),void t.status(h.HttpStatusCode.Forbidden).send(new f.SocialError("ServerError/Unauthorized","User is Unauthorized!"));let o;e.headers.authorization&&e.headers.authorization.startsWith("Bearer ")?(console.log('Found "Authorization" header'),o=e.headers.authorization.split("Bearer ")[1]):(console.log('Found "__session" cookie'),o=e.cookies.__session),a.adminDB.auth().verifyIdToken(o).then(t=>(console.log("ID Token correctly decoded",t),e.user=t,r())).catch(e=>{console.error("Error while verifying Firebase ID token:",e),t.status(h.HttpStatusCode.Forbidden).send(new f.SocialError("ServerError/Unauthorized","User is Unauthorized!"))})}),b.post("/api/sms-verification",(e,t)=>o(void 0,void 0,void 0,(function*(){const r=e.connection.remoteAddress,o=e.body["g-recaptcha-response"],n=Math.floor(1e3+9e3*Math.random()),s=e.body.phoneNumber,c=`Verification code from ${y} : <CODE>`,u=i.config().recaptcha.secretkey,l=e.user.uid;if(void 0===o||""===o||null===o)return t.json(new f.SocialError("ServerError/NullCaptchaValue","Please select captcha first"));v("https://www.google.com/recaptcha/api/siteverify?secret="+u+"&response="+o+"&remoteip="+r,(e,o,u)=>{void 0===(u=JSON.parse(u)).success||u.success||(console.log("Captha/responseError",e),console.log("Captha/responseError",o),console.log("Captha/responseError",u),t.status(h.HttpStatusCode.BadRequest).json(new f.SocialError("ServerError/ResponseCaptchaError","Failed captcha verification"))),console.log("Captha/responseSuccess"),new m.Client(i.config().plivo.authid,i.config().plivo.authtoken).messages.create("+111111",s,c.replace("<CODE>",String(n))).then(()=>{const e=a.firestoreDB.collection("verification").doc(l).collection("phone").doc(),o=new p.Verification(e.id,String(n),s,d.default().unix(),r,l);return e.set(Object.assign({},o)),t.status(h.HttpStatusCode.OK).json({verifyId:e.id})})})}))),b.post("/api/verify-phone",(e,t)=>o(void 0,void 0,void 0,(function*(){const r=e.connection.remoteAddress,o=e.body.code,n=e.body.verifyId,s=e.body.phoneNumber,i=e.user.uid;return a.firestoreDB.collection("verification").doc(i).collection("phone").doc(n).get().then(n=>{const c=n.data();if(console.log(c,e.body,!c.isVerified,r===c.remoteIpAddress,s===c.target,i===c.userId),c.isVerified||r!==c.remoteIpAddress||s!==c.target||i!==c.userId)t.status(h.HttpStatusCode.Forbidden).send(new f.SocialError("ServerError/Unauthorized","User is Unauthorized!"));else if(Number(c.code)===Number(o)){const e=a.firestoreDB.batch();e.update(n.ref,{isVerified:!0});const r=a.firestoreDB.collection("protectedUser").doc(i);e.update(r,{phoneVerified:!0}),e.commit().then(()=>{console.log("ServerSuccess/CodeAccepted","CodeAccepted");a.adminDB.auth().createCustomToken(i,{phoneVerified:!0}).then(e=>t.status(h.HttpStatusCode.OK).json({token:e})).catch(e=>{console.log("Error creating custom token:",e)})}).catch(e=>{console.log("ServerError/CanUpdateState",e),t.json(new f.SocialError("ServerError/CanUpdateState","Can not update user state!"))})}else t.status(h.HttpStatusCode.Forbidden).json(new f.SocialError("ServerError/WrongCode","The code is not correct!"))}).catch(e=>(console.log("ServerError/VerifyIdNotAccept",e),t.json(new f.SocialError("ServerError/VerifyIdNotAccept","We coudn't for you verification!"))))}))),b.post("/api/register",(e,t)=>o(void 0,void 0,void 0,(function*(){const r=e.body.userName,o=e.body.password,n=e.body.email,s=e.body.fullName,i=e.body.avatar,c=e.user.uid;a.firestoreDB.doc(`userInfo/${c}`).set({id:c,state:"active",avatar:i,fullName:s,creationDate:d.default().unix(),email:n}).then(()=>{g.hash(o,10,(e,o)=>{a.firestoreDB.collection("protectedUser").doc(c).set({userName:r,password:o,phoneVerified:!1}).then(()=>t.status(h.HttpStatusCode.OK).json({})).catch(()=>{t.status(h.HttpStatusCode.InternalServerError).send(new f.SocialError("ServerError/NotStoreProtectedUser","Can not store protected user!"))})})}).catch(()=>{t.status(h.HttpStatusCode.InternalServerError).send(new f.SocialError("ServerError/NotStoreUserInfo","Can not store user info!"))})}))),b.post("/api/update-password",(e,t)=>o(void 0,void 0,void 0,(function*(){const r=e.body.newPassword,o=e.body.confirmPassword,n=e.user.uid;console.log("userID: ",n),r&&o&&""!==r.trim()&&""!==o.trim()&&o===r?a.adminDB.auth().updateUser(n,{password:r}).then(()=>{g.hash(r,10,(e,r)=>{a.firestoreDB.collection("protectedUser").doc(n).update({password:r}).then(()=>t.status(h.HttpStatusCode.OK).json({})).catch(e=>{console.log("ServerError/NotStoreProtectedUser",e),t.status(h.HttpStatusCode.InternalServerError).send(new f.SocialError("ServerError/NotStoreProtectedUser","Can not store protected user!"))})})}).catch(e=>{console.log("UpdateUser/Password",e),t.status(h.HttpStatusCode.InternalServerError).send(new f.SocialError("ServerError/ErrorUpdateUser","Can not update user!"))}):t.status(h.HttpStatusCode.InternalServerError).send(new f.SocialError("ServerError/NotEqualConfirmNewPassword","Confirm password and new password are not equal!"))}))),t.auth=i.https.onRequest(b)},function(e,t){e.exports=require("firebase-admin")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=r(2);class n extends o.BaseDomain{}t.Circle=n},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class o extends Error{constructor(e,t){super(t),this._code=e,this._message=t,this._isError=!0}get code(){return this._code}get message(){return this._message}get isError(){return this._isError}}t.SocialError=o},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.BaseDomain=class{}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.Feed=class{constructor(e,t,r,o){this.id=e,this.text=t,this.feedType=r,this.user=o}}},function(e,t){e.exports=require("plivo")},function(e,t,r){"use strict";var o=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(n,s){function i(e){try{c(o.next(e))}catch(e){s(e)}}function a(e){try{c(o.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,a)}c((o=o.apply(e,t||[])).next())}))},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=n(r(0)),a=r(1),c=s(r(5)),d=s(r(3)),u=n(r(6)),l=r(2),f=r(7),p=r(12),h=r(13),m=r(4),v=r(10),S=r(8),g=r(9)(),y=d.default(),b=r(11)({origin:!0});y.disable("x-powered-by"),y.use(b),y.use(u.json()),y.use(g);const w=i.config().gmail.email,E=i.config().setting.appname;y.post("/api/login",(e,t)=>o(void 0,void 0,void 0,(function*(){const r=e.body.userName,o=e.body.password;console.log(r,o),a.firestoreDB.collection("protectedUser").where("userName","==",r).get().then(e=>{if(console.log("result",e.size,e.empty),!e||e.empty||1!==e.size)return t.status(m.HttpStatusCode.InternalServerError).send(new l.SocialError("ServerError/WrongUserName","User name is wrong!"));{const r=e.docs[0];console.log(r);const n=r.data();console.log("data = ",n),v.compare(o,n.password,(e,o)=>{if(!0!==o)return t.status(m.HttpStatusCode.InternalServerError).send(new l.SocialError("ServerError/WrongPassword","Password is wrong!"));{const e={phoneVerified:n.phoneVerified,userName:n.userName};a.adminDB.auth().createCustomToken(r.id,e).then(e=>t.status(m.HttpStatusCode.OK).json({token:e})).catch(e=>(console.log("Error creating custom token:",e),t.status(m.HttpStatusCode.InternalServerError).send(new l.SocialError("ServerError/CreateToke","Error on creating token!"))))}})}}).catch(e=>t.status(m.HttpStatusCode.InternalServerError).send(new l.SocialError("ServerError/FirestoreGetData",e)))}))),y.post("/api/verify-email",(e,t)=>o(void 0,void 0,void 0,(function*(){const r=e.connection.remoteAddress,o=e.body.code,n=e.body.verifyId,s=e.body.email;a.firestoreDB.collection("userInfo").where("email","==",s).get().then(i=>{if(console.log("userInfo",i.size,i.empty),i&&!i.empty&&1===i.size){const c=i.docs[0],d=c.id;console.log(c);const u=c.data();return console.log("data = ",u),a.firestoreDB.collection("verification").doc(d).collection("resetPassword").doc(n).get().then(n=>{const i=n.data();console.log(i,e.body,!i.isVerified,r===i.remoteIpAddress,s===i.target,d===i.userId),i.isVerified||r!==i.remoteIpAddress||s!==i.target||d!==i.userId?t.status(m.HttpStatusCode.Forbidden).send(new l.SocialError("ServerError/Unauthorized","User is Unauthorized!")):Number(i.code)===Number(o)?a.firestoreDB.collection("protectedUser").doc(d).get().then(e=>{let r=!1;e.exists&&e.data().phoneVerified&&(r=!0),console.log("ServerSuccess/CodeAccepted","CodeAccepted",r);const o={phoneVerified:r,userName:u.email,resetPasswordVerified:!0};a.adminDB.auth().createCustomToken(d,o).then(e=>t.status(m.HttpStatusCode.OK).json({token:e})).catch(e=>{console.log("Error creating custom token:",e),t.status(m.HttpStatusCode.InternalServerError).json(new l.SocialError("ServerError/CreateCustomToken","Create custom token error!"))})}):t.status(m.HttpStatusCode.Forbidden).json(new l.SocialError("ServerError/WrongCode","The code is not correct!"))}).catch(e=>(console.log("ServerError/VerifyIdNotAccept",e),t.json(new l.SocialError("ServerError/VerifyIdNotAccept","We coudn't for you verification!"))))}t.status(m.HttpStatusCode.NotFound).send(new l.SocialError("ServerError/EmailNotFound","Email not found!"))}).catch(()=>{t.status(m.HttpStatusCode.NotFound).send(new l.SocialError("ServerError/EmailNotFound","Email not found!"))})}))),y.post("/api/email-verification-code",(e,t)=>o(void 0,void 0,void 0,(function*(){const r=e.connection.remoteAddress,o=e.body["g-recaptcha-response"],n=Math.floor(1e3+9e3*Math.random()),s=e.body.email,d=i.config().recaptcha.secretkey,u=`${E} Reset Password <${w}>`,v=s,g=`Reset your password for ${E}`;a.firestoreDB.collection("userInfo").where("email","==",s).get().then(e=>{if(1===e.size){const i=e.docs[0].data(),y=e.docs[0].id,b=`\n                <html xmlns="http://www.w3.org/1999/xhtml">\n\n                <body>\n                <div>\n                    <h4>Hello ${i.fullName},</h4>\n\n                    <p>Enter verification code in your reset password page to reset your ${E} password for your ${s} account.</p>\n\n                    <h3>Verification Code: ${n}</h3>\n\n                    <p>If you didn’t ask to reset your password, you can ignore this email.</p>\n\n                    <h4>Thanks,</h4>\n\n                    <h4>Your ${E} team</h4>\n                </div>\n                </body>\n                </html>\n                        `;if(void 0===o||""===o||null===o)return t.json(new l.SocialError("ServerError/NullCaptchaValue","Please select captcha first"));S("https://www.google.com/recaptcha/api/siteverify?secret="+d+"&response="+o+"&remoteip="+r,(e,o,i)=>{if(void 0!==(i=JSON.parse(i)).success&&!i.success)return console.log("Captha/responseError",e),t.json(new l.SocialError("ServerError/ResponseCaptchaError","Failed captcha verification"));console.log("Captha/responseSuccess"),p.emailAPI.sendEmail(new h.Email(u,v,g,b)).then(()=>{const e=a.firestoreDB.collection("verification").doc(y).collection("resetPassword").doc(),o=new f.Verification(e.id,String(n),s,c.default().unix(),r,y);return e.set(Object.assign({},o)),t.status(m.HttpStatusCode.OK).json({verifyId:e.id})}).catch(()=>{t.status(m.HttpStatusCode.ServiceUnavailable).send(new l.SocialError("ServerError/EmailNotSent","Email service error. Email has not sent!"))})})}else t.status(m.HttpStatusCode.NotFound).send(new l.SocialError("ServerError/EmailNotFound","Email not found!"))}).catch(()=>{t.status(m.HttpStatusCode.NotFound).send(new l.SocialError("ServerError/EmailNotFound","With DB error. Email not found!"))})}))),t.publicAuth=i.https.onRequest(y)},function(e,t){e.exports=require("nodemailer")},function(e,t,r){"use strict";var o=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(n,s){function i(e){try{c(o.next(e))}catch(e){s(e)}}function a(e){try{c(o.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,a)}c((o=o.apply(e,t||[])).next())}))},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=n(r(0)),a=r(1),c=s(r(3)),d=r(4),u=r(2),l=c.default();l.disable("x-powered-by");l.post("/",(e,t)=>o(void 0,void 0,void 0,(function*(){const r=JSON.parse(e.body);if(!(r&&Array.isArray(r)&&r.length>0))return t.status(d.HttpStatusCode.BadRequest).send(new u.SocialError("UserService/UserIdListNotValid",`\n            User list is undefined or not array or the length of array is not grater than zero!\n            ${JSON.stringify(r)}\n            `));(e=>o(void 0,void 0,void 0,(function*(){return new Promise((t,r)=>{let o={};e&&e.length>0&&(e.forEach(e=>{a.firestoreDB.collection("userInfo").doc(e).get().then(t=>{let r=t.data();o=Object.assign(Object.assign({},o),{[e]:Object.assign({},r)})}).catch(r)}),t(o))})})))(r).then(e=>t.status(d.HttpStatusCode.OK).send(e))}))),t.users=i.https.onRequest(l),t.onUpdateUserInfo=i.firestore.document("userInfo/{userId}").onUpdate((e,t)=>new Promise((r,o)=>{const n=t.params.userId,s=e.before.data(),i=e.after.data();if(s.avatar===i.avatar&&s.fullName===i.fullName)r();else{const e=a.firestoreDB.collection("posts").where("ownerUserId","==",n),t=a.firestoreDB.collection("comments").where("userId","==",n),s=a.firestoreDB.collection("graphs:users").where("leftNode","==",n),d=a.firestoreDB.collection("graphs:users").where("rightNode","==",n);var c=a.firestoreDB.batch();e.get().then(e=>{t.get().then(t=>{s.get().then(n=>{d.get().then(s=>{e.forEach(e=>{const t=e.data();t.ownerAvatar=i.avatar,t.ownerDisplayName=i.fullName,c.update(e.ref,t)}),t.forEach(e=>{const t=e.data();t.userDisplayName=i.avatar,t.userDisplayName=i.fullName,c.update(e.ref,t)}),n.forEach(e=>{const t=e.data(),r=t.LeftMetadata;r.avatar=i.avatar,r.fullName=i.fullName,t.LeftMetadata=r,c.update(e.ref,t)}),s.forEach(e=>{const t=e.data(),r=t.rightMetadata;r.avatar=i.avatar,r.fullName=i.fullName,t.rightMetadata=r,c.update(e.ref,t)}),c.commit().then(()=>{r()}).catch(o)})})})})}}))},function(e,t,r){"use strict";var o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const n=o(r(0)),s=r(12),i=r(13),a=n.config().gmail.email,c=n.config().setting.appname;t.onCreateFeedback=n.firestore.document("feeds/{feedId}").onCreate(e=>new Promise((t,r)=>{const o=e.data(),n=`${c} Feedback <${a}>`,d=`${o.feedType} -${o.user.email} - ${e.createTime}`,u=`\n    Feedback type: ${o.feedType}\n    Feedback ID: ${o.id}\n  \n    User Email: ${o.user.email}\n    User Fullname: ${o.user.fullName}\n    User ID: ${o.user.userId}\n  \n    Feedback: ${o.text}\n    `;s.emailAPI.sendEmail(new i.Email(n,"amir.gholzam@gmail.com",d,u)).then(()=>{t()}).catch(()=>{r()})}))},function(e,t,r){"use strict";var o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const n=o(r(0)),s=r(1),i=r(27);t.onAddComment=n.firestore.document("comments/{commentId}").onCreate((e,t)=>{var r=e.data();const o=t.params.commentId;if(r){const e=s.firestoreDB.doc(`posts/${r.postId}`);return s.firestoreDB.runTransaction(t=>t.get(e).then(n=>{if(n.exists){const s=n.data(),a=s.commentCounter+1;t.update(e,{commentCounter:a});let c=s.comments;if(c||(c={}),a<4)t.update(e,{comments:Object.assign(Object.assign({},c),{[o]:r})});else{let n=Object.assign(Object.assign({},c),{[o]:r});n=i.fromPairs(i.toPairs(n).sort((e,t)=>parseInt(t[1].creationDate,10)-parseInt(e[1].creationDate,10)).slice(0,3)),t.update(e,{comments:Object.assign({},n)})}}}))}}),t.onDeleteComment=n.firestore.document("comments/{commentId}").onDelete(e=>new Promise((t,r)=>{const o=e.data().postId,n=s.firestoreDB.doc(`posts/${o}`);s.firestoreDB.collection("comments").where("postId","==",o).orderBy("creationDate","desc").get().then(e=>{let r={},o=0;e.forEach(e=>{if(o<3){const t=e.data();t.id=e.id,r=Object.assign(Object.assign({},r),{[e.id]:Object.assign({},t)})}o++}),n.update({comments:r,commentCounter:e.size}).then(()=>{t()})}).catch(r)}))},function(e,t){e.exports=require("lodash")}]));